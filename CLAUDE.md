# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview
This is a full-stack application built on Cloudflare Workers using RWSDK (React framework with SSR/RSC), Drizzle ORM with D1 database, Better Auth for authentication, and Zod for validation.

## Essential Commands

### Development
```bash
bun dev                 # Start dev server on localhost:5173
bun build              # Production build
bun preview            # Preview production build
```

### Database Operations
```bash
bun ba:generate        # Generate Better Auth schema from src/lib/auth-cli.ts
bun db:generate        # Generate Drizzle migrations
bun migrate:new        # Run both ba:generate and db:generate
bun migrate:dev        # Apply migrations to local D1
bun migrate:prd        # Apply migrations to production
bun db:studio          # Start Drizzle Studio for database GUI
```

### Deployment
```bash
bun release            # Full deployment: migrations + build + deploy
bunx wrangler d1 create <name>  # Create new D1 database
wrangler tail          # View live logs
```

## Architecture

### Server Actions & Cookie Handling
**Critical**: RWSDK server actions cannot return Response objects - they get converted to `null`. Use `requestInfo.response.headers` to set cookies:

```typescript
// ✅ CORRECT
const { request, response } = requestInfo;
response.headers.set('Set-Cookie', cookieValue);
return { success: true };  // Plain object

// ❌ WRONG
return new Response(data, { headers: { 'Set-Cookie': value }});
```

### Authentication Flow
- Better Auth handler at `/api/auth/*` route in `src/worker.tsx`
- Auth config in `src/lib/auth.ts` uses Drizzle adapter with D1
- Session cookies must be forwarded explicitly in server actions
- Use `asResponse: true` when calling Better Auth APIs to access headers

### Validation Pattern
All user input goes through Zod validation:
```typescript
const validation = validate(schema, data);
if (!validation.success) {
  return { success: false, errors: validation.errors };
}
// Use validation.data (fully typed)
```

### Database Structure
- `src/db/auth-schema.ts` - Auto-generated by Better Auth CLI
- `src/db/schema.ts` - Application schemas
- `src/db/index.ts` - Exports combined schema and typed helpers

### Route Protection
Interruptors in `src/app/interruptors.ts` handle auth checks:
```typescript
route("/protected", [requireAuth, Component])
```

## Key Configuration Files

### Environment Variables
Required in `.env`:
- `BETTER_AUTH_SECRET` - Generate with `openssl rand -base64 32`
- `BETTER_AUTH_URL` - Base URL for auth
- `BA_TRUSTED_ORIGINS` - Comma-separated allowed origins
- `CLOUDFLARE_ACCOUNT_ID`, `CLOUDFLARE_DATABASE_ID`, `CLOUDFLARE_D1_TOKEN`

### D1 Database Binding
Update `wrangler.jsonc` with database ID after creation:
```jsonc
{
  "d1_databases": [{
    "binding": "DB",
    "database_name": "your-db",
    "database_id": "your-id"
  }]
}
```

## Common Issues & Solutions

### Better Auth Error Messages
Parse JSON error responses from Better Auth:
```typescript
try {
  const errorData = JSON.parse(error.message);
  errorMessage = errorData.message || errorData.error;
} catch {
  errorMessage = error.message;
}
```

### Session Not Persisting
Check cookie forwarding in server actions - see architecture section above.

### Path Aliases
Configured in `tsconfig.json`:
- `@/` → `src/`
- `@/lib` → `src/lib`
- `@/db` → `src/db`